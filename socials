#!/usr/bin/env python3
import sys
import os
from typing import Dict, List, Optional

MODULE_CONFIGS = {
    'utils': {
        'path_template': 'services/utils/{module}/{filename}',
        'modules': {
            'action': 'action.py',
            'connection': 'connection.py',
            'ideas': 'idea.py',
            'networking': 'networking.py',
            'suggestions': 'suggestions.py'
        },
        'profile_required': True
    },
    'platform': {
        'path_template': 'services/platform/{filename}',
        'modules': {
            'global': 'global.py'
        }
    },
    'x': {
        'path_template': 'services/platform/x/{filename}',
        'modules': {
        'dm': 'dm.py',
        'post': 'post.py',
        'reply': 'reply.py',
        'scraper': 'scraper.py'
    }
    },
    'linkedin': {
        'path_template': 'services/platform/linkedin/{filename}',
        'modules': {
            'connection': 'connection.py',
            'dm': 'dm.py',
            'scraper': 'scraper.py',
            'post': 'post.py',
            'reply': 'reply.py'
        }
    },
    'producthunt': {
        'path_template': 'services/platform/producthunt/{filename}',
        'modules': {
            'scraper': 'scraper.py'
        }
    },
    'ycombinator': {
        'path_template': 'services/platform/ycombinator/{filename}',
        'modules': {
            'scraper': 'scraper.py'
        }
    }
}

def get_usage():
    return """
        Usage:
        socials <platform> <profile> <module> [args...]     # Platform modules
        socials utils <profile> <module>                   # Utils modules with profile
        socials <profile> global <command>                 # Global profile management
        socials <profile> global <platform> <action>       # Platform-specific auth

        Examples:
        socials x <profile> scraper --verbose
        socials utils <profile> action
        socials <profile> global init
        socials <profile> global x login
    """

def parse_args() -> Optional[Dict]:
    if len(sys.argv) < 3:
        print(get_usage())
        return None

    # Check for new global command pattern: socials <profile> global <command> [platform] [action]
    if len(sys.argv) >= 3 and sys.argv[2] == "global":
        profile = sys.argv[1]
        if len(sys.argv) < 4:
            print("Usage: socials <profile> global <command> [platform] [action]")
            return None

        command = sys.argv[3]

        if command in ["init", "delete"]:
            # socials <profile> global init/delete
            return {
                'category': 'platform',
                'profile': profile,
                'module': 'global',
                'args': [profile, command]
            }
        elif len(sys.argv) >= 5 and command in ["x", "linkedin"]:  # platform names
            # socials <profile> global <platform> <action>
            platform = command
            action = sys.argv[4]
            if action in ["login", "check-credentials"]:
                return {
                    'category': 'platform',
                    'profile': profile,
                    'module': 'global',
                    'args': [profile, platform, action]
                }
            else:
                print(f"Unknown action: {action}")
                print("Available actions: login, check-credentials")
                return None
        else:
            print(f"Unknown command: {command}")
            print("Available commands: init, delete, or platform names (x, linkedin) followed by action")
            return None

    category = sys.argv[1]

    if category not in MODULE_CONFIGS:
        available_categories = ', '.join(MODULE_CONFIGS.keys())
        print(f"Unknown category: {category}")
        print(f"Available categories: {available_categories}")
        return None

    config = MODULE_CONFIGS[category]

    if 'platform' in config.get('path_template', ''):
        if len(sys.argv) < 4:
            print("Usage: socials <platform> <profile> <module> [args...]")
            return None

        profile = sys.argv[2]
        module = sys.argv[3]
        args = sys.argv[4:]

        if module not in config['modules']:
            available = ', '.join(config['modules'].keys())
            print(f"Unknown {category} module: {module}")
            print(f"Available {category} modules: {available}")
            return None

        if args and module in ['post', 'reply', 'scraper', 'global', 'connection']:
            args = [args[0], '--profile', profile] + args[1:]
        elif module in ['dm', 'post', 'scraper'] or (category == 'ycombinator' and module == 'scraper'):
            args = ['--profile', profile]

        return {
            'category': category,
            'profile': profile,
            'module': module,
            'args': args
        }

    if config.get('profile_required', False):
        # Check if this is an action command with multiple profiles
        # Pattern: socials utils <profile1> [profile2] [profile3] ... action [additional args]
        action_index = None
        for i in range(2, len(sys.argv)):
            if sys.argv[i] == 'action':
                action_index = i
                break

        if action_index is not None:
            module = 'action'
            profiles = sys.argv[2:action_index] if action_index >= 3 else []  # Profiles before 'action', or empty
            additional_args = sys.argv[action_index + 1:]  # Additional args after 'action'

            return {
                'category': category,
                'profile': profiles[0] if profiles else 'default',  # Use first profile or default for compatibility
                'module': module,
                'args': profiles + additional_args
            }

        # Handle action module with optional profiles: socials utils action [profile1] [profile2] ... [additional args]
        if len(sys.argv) >= 3 and sys.argv[2] == 'action':
            module = sys.argv[2]
            # Find where profiles end and additional args begin
            profiles = []
            additional_args = []
            found_non_profile = False

            for arg in sys.argv[3:]:
                if not found_non_profile and not arg.startswith('-'):
                    profiles.append(arg)
                else:
                    found_non_profile = True
                    additional_args.append(arg)

            # Action can work without profiles (reads from profile configs)
            return {
                'category': category,
                'profile': profiles[0] if profiles else 'default',  # Use first profile or default for compatibility
                'module': module,
                'args': profiles + additional_args
            }

        # Standard utils modules: socials utils <profile> <module>
        if len(sys.argv) < 4:
            print(f"Usage: socials {category} <profile> <module> [args...] or socials {category} <profile1> [profile2] ... action")
            return None

        profile = sys.argv[2]
        module = sys.argv[3]

        if module not in config['modules']:
            available = ', '.join(config['modules'].keys())
            print(f"Unknown {category} module: {module}")
            print(f"Available {category} modules: {available}")
            return None

        if module == 'suggestions' and len(sys.argv) > 5:
            platform_arg = sys.argv[4]
            command_arg = sys.argv[5]
            args = [profile, platform_arg, command_arg]
        else:
            args = [profile]

        return {
            'category': category,
            'profile': profile,
            'module': module,
            'args': args
        }

    module = sys.argv[2]
    args = sys.argv[3:]

    if module not in config['modules']:
        available = ', '.join(config['modules'].keys())
        print(f"Unknown {category} module: {module}")
        print(f"Available {category} modules: {available}")
        return None

    return {
        'category': category,
        'module': module,
        'args': args
    }

def get_module_path(config: Dict) -> str:
    category_config = MODULE_CONFIGS[config['category']]
    filename = category_config['modules'][config['module']]
    path_template = category_config['path_template']
    relative_path = path_template.format(module=config['module'], filename=filename)

    module_path = os.path.join(os.getcwd(), relative_path)
    if os.path.exists(module_path):
        return module_path

    script_dir = os.path.dirname(os.path.abspath(__file__))
    module_path = os.path.join(script_dir, relative_path)
    if os.path.exists(module_path):
        return module_path

    script_path = os.path.abspath(__file__)
    if os.path.islink(script_path):
        actual_script_dir = os.path.dirname(os.readlink(script_path))
        module_path = os.path.join(actual_script_dir, relative_path)
        if os.path.exists(module_path):
            return module_path

    return os.path.join(os.getcwd(), relative_path)
    
def execute_module(module_path: str, args: List[str]):
    if not os.path.exists(module_path):
        print(f"Module file not found: {module_path}")
        sys.exit(1)

    script_path = os.path.abspath(__file__)
    if os.path.islink(script_path):
        project_dir = os.path.dirname(os.readlink(script_path))
    else:
        project_dir = os.path.dirname(script_path)

    venv_python = os.path.join(project_dir, "venv", "bin", "python")
    python_exe = venv_python if os.path.exists(venv_python) else sys.executable

    env = os.environ.copy()
    env['PYTHONPATH'] = project_dir

    cmd = [python_exe, module_path] + args
    os.execvpe(python_exe, cmd, env)

def main():
    config = parse_args()
    if config is None:
        sys.exit(1)

    module_path = get_module_path(config)
    execute_module(module_path, config['args'])

if __name__ == "__main__":
    main()
